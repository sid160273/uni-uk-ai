from flask import Flask, render_template, request
from openai import OpenAI
import os
import psycopg2

app = Flask(__name__)

client = OpenAI(
    api_key=os.getenv("OPENAI_API_KEY")
)

# Database connection
DATABASE_URL = os.environ['DATABASE_URL']
conn = psycopg2.connect(DATABASE_URL, sslmode='require')

def get_chatbot_response(user_input):
    try:
        response = client.chat.completions.create(
          model="gpt-4-vision-preview",
          messages=[
              {"role": "system", "content": "You are a helpful assistant."},
              {"role": "user", "content": user_input}
          ],
          max_tokens=4096
        )
        response_content = response.choices[0].message.content

        # Save to database
        with conn.cursor() as cur:
            cur.execute("INSERT INTO chat_history (user_input, bot_response) VALUES (%s, %s)", (user_input, response_content))
            conn.commit()

        return response_content
    except Exception as e:
        return str(e)

@app.route('/', methods=['GET', 'POST'])
def home():
    # ... existing code ...

if __name__ == '__main__':
    # ... existing code ...
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=False)  # Note the uppercase 'F' in 'False'



